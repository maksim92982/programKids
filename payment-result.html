<!DOCTYPE html>
<html lang="ru">
<meta charset="utf-8">
<title>Результат оплаты</title>
<body>
<h2 id="title">Завершаем оплату…</h2>
<div id="details" style="font-family:Arial; font-size:14px; color:#333"></div>
<script>
(async function () {
  const titleEl = document.getElementById('title');
  const detailsEl = document.getElementById('details');
  try {
    const url = new URL(location.href);
    let email = (url.searchParams.get('email') || '').trim().toLowerCase();
    let moduleLabel = (url.searchParams.get('module') || '').trim();
    const orderId = (url.searchParams.get('id') || url.searchParams.get('order_id') || '').trim();

    // Fallback: берём детали заказа из localStorage, если провайдер не вернул email/module
    if (!email || !moduleLabel) {
      try {
        const cached = JSON.parse(localStorage.getItem('last-order') || '{}');
        if (cached && cached.email && cached.module) {
          email = String(cached.email).trim().toLowerCase();
          moduleLabel = String(cached.module).trim();
        }
      } catch (_) {}
    }

    if (!email || !moduleLabel) {
      titleEl.textContent = 'Оплата получена. Завершение может занять время.';
      detailsEl.textContent = 'Мы не получили email/module из шлюза. Если письмо не придёт — свяжитесь с поддержкой.';
      return;
    }

    const resp = await fetch('/api/callback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, module: moduleLabel, order_id: orderId, status: 'succeeded' })
    });

    if (!resp.ok) {
      titleEl.textContent = 'Оплата получена, но обработка задерживается.';
      detailsEl.textContent = 'Мы отправим письмо с доступом на ваш email в ближайшее время.';
      setTimeout(() => { location.href = '/'; }, 2500);
      return;
    }

    titleEl.textContent = 'Оплата прошла успешно. Доступ будет отправлен на email.';
    detailsEl.innerHTML = 'Email: <b>' + email + '</b><br>Модуль: <b>' + moduleLabel + '</b>';
    setTimeout(() => { location.href = '/'; }, 1800);
  } catch (e) {
    titleEl.textContent = 'Ошибка завершения оплаты.';
    detailsEl.textContent = 'Повторите попытку позже.';
  }
})();
</script>
</body>
</html>
